WITH
  VT_1 AS (
  SELECT
    DATE_TRUNC(DataInteresa, YEAR) AS GodInteresa,
    KodKontragenta1 AS KodKontragenta,
    KodGolovnogoKontragenta AS KodGolovnogoKontragenta,
    AVG(VyruchkaKontragenta) AS VyruchkaKontragenta
  FROM
    `crm-kis.leads_CRM.leads_with_catalogs_view`

  GROUP BY
    GodInteresa,
    KodKontragenta,
    KodGolovnogoKontragenta ),
  VT_2 AS (
  SELECT
    GodInteresa,
    KodGolovnogoKontragenta,
    SUM(VyruchkaKontragenta) AS VyruchkaGolovnogoKontragenta
  FROM
    VT_1
  GROUP BY
   GodInteresa, KodGolovnogoKontragenta),
  VT_3 AS (
  SELECT
    DataInteresa,
    DATE_TRUNC(DataInteresa, YEAR) AS GodInteresa,
    NomerInteresa,
    DataOsnovaniyaInteresa,
    NomerOsnovaniyaInteresa,
    StatusInteresa,
    PervichnoeNapravlenie,
    RoditelNapravleniya,
    Departament,
    InteresPometkaUdaleniya,
    SutObrashcheniya,
    SposobPostupleniyaInformacii,
    IstochnikInformacii,
    IstochnikInformaciiIzmenenVRuchnuyu,
    GruppaIstochnikaInformacii,
    NeVpervye,
    DataPervichnogoInteresa,
    NomerPervichnogoInteresa,
    PrichinaNepodgotovkiPredlozheniya,
    TipSobytiya,
    VidSobytiya,
    RegionCRM,
    KodKontragenta1 AS KodKontragenta,
    OcenkaKachestvaInteresa,
    DataPervogoPredlozheniyaSOtkazom,
    NomerPervogoPredlozheniyaSOtkazom,
    DataPoslednegoPredlozheniyaSOtkazom,
    NomerPoslednegoPredlozheniyaSOtkazom,
    PoslednyayaStranica,
    NapravlenieDlyaKollTrekingaPoslednyayaStranica,
    StranicaVhoda,
    NapravlenieDlyaKollTrekingaStranicaVhoda,
    DataZvonka,
    Avtozvonok,
    EstDannyeKollTrekinga,
    UtmSource,
    UtmMedium,
    CRM_UTMSource,
    CRM_UTMMedium,
    UtmContent,
    UtmCampaign,
    UtmTerm,
    Referrer,
    Callback,
    CallId,
    Keyword,
    ClientId,
    Ip,
    FormId,
    SrednespisochnayaCHislennost,
    Napravlenie,
    NapravlenieRoditel,
    NapravlenieVerhnijUroven,
    Sotrudnik,
    PodrazdelenieSotrudnika,
    PodrazdelenieSotrudnikaRoditel,
    DataUvolneniya,
    Kontragent,
    KodGolovnogoKontragenta,
    GolovnojKontragent,
    MAX(KvalificirovannyeInteresy) AS KvalificirovannyeInteresy,
    MAX(OplachennyeInteresy) AS OplachennyeInteresy,
    SUM(SummaOplaty) AS SummaOplaty,
    MAX(VseInteresy) AS VseInteresy,
    MAX(DataPredlozheniya) AS DataPredlozheniya,
    MAX(NomerPredlozheniya) AS NomerPredlozheniya,
    SUM(SummaPredlozheniya) AS SummaVsekhPredlozheniya,
    MIN(MinSummaPredlozheniya) AS MinSummaPredlozheniya,
    AVG(RaschetnayaSummaPredlozheniya) AS SrednayRaschetnayaSummaPredlozheniya,
    SUM(VsePredlozheniya) AS SumVsePredlozheniya,
    MAX(KvalificirovannyeInteresySrednyayaOcenkaKachestva) AS KvalificirovannyeInteresySrednyayaOcenkaKachestva,
    MAX(OplachennyeInteresyPoStatusu) AS OplachennyeInteresyPoStatusu,
    MAX(OplachennyeInteresySrednyayaOcenkaKachestva) AS OplachennyeInteresySrednyayaOcenkaKachestva,
    MAX(OplachennyeInteresyPoStatusuSrednyayaOcenkaKachestva) AS OplachennyeInteresyPoStatusuSrednyayaOcenkaKachestva,
    MAX(DnejOtPostupleniyaDoOplaty) AS DnejOtPostupleniyaDoOplaty,
    MAX(UchityvatPriRascheteDnejOtPostupleniyaDoOplaty) AS UchityvatPriRascheteDnejOtPostupleniyaDoOplaty,
    MAX(VseInteresySrednyayaOcenkaKachestva) AS VseInteresySrednyayaOcenkaKachestva,
    SUM(KolichestvoPredlozhenijSOtkazom) AS KolichestvoPredlozhenijSOtkazom,
    MAX(PrichinaOtkaza) AS PrichinaOtkaza,
    MAX(TipUstrojstva) AS TipUstrojstva,
    MAX(MaxSummaPredlozheniya) AS MaxSummaPredlozheniya,
    AVG(SrednyayaSummaPredlozheniya) AS SrednyayaSummaPredlozheniya,
    AVG(VyruchkaKontragenta) AS SummaVyruchkaKontragenta,
    SUM(SummaOplatyBezTranzita) AS SummaOplatyBezTranzita,
    SUM(SummaVozvrataBezTranzita) AS SummaVozvrataBezTranzita,
  FROM
    `crm-kis.leads_CRM.leads_with_catalogs_view`
  GROUP BY
    DataInteresa,
    GodInteresa,
    NomerInteresa,
    DataOsnovaniyaInteresa,
    NomerOsnovaniyaInteresa,
    StatusInteresa,
    PervichnoeNapravlenie,
    RoditelNapravleniya,
    Departament,
    InteresPometkaUdaleniya,
    SutObrashcheniya,
    SposobPostupleniyaInformacii,
    IstochnikInformacii,
    IstochnikInformaciiIzmenenVRuchnuyu,
    GruppaIstochnikaInformacii,
    NeVpervye,
    DataPervichnogoInteresa,
    NomerPervichnogoInteresa,
    PrichinaNepodgotovkiPredlozheniya,
    TipSobytiya,
    VidSobytiya,
    RegionCRM,
    KodKontragenta1,
    OcenkaKachestvaInteresa,
    DataPervogoPredlozheniyaSOtkazom,
    NomerPervogoPredlozheniyaSOtkazom,
    DataPoslednegoPredlozheniyaSOtkazom,
    NomerPoslednegoPredlozheniyaSOtkazom,
    PoslednyayaStranica,
    NapravlenieDlyaKollTrekingaPoslednyayaStranica,
    StranicaVhoda,
    NapravlenieDlyaKollTrekingaStranicaVhoda,
    DataZvonka,
    Avtozvonok,
    EstDannyeKollTrekinga,
    UtmSource,
    UtmMedium,
    CRM_UTMSource,
    CRM_UTMMedium,
    UtmContent,
    UtmCampaign,
    UtmTerm,
    Referrer,
    Callback,
    CallId,
    Keyword,
    ClientId,
    Ip,
    FormId,
    SrednespisochnayaCHislennost,
    Napravlenie,
    NapravlenieRoditel,
    NapravlenieVerhnijUroven,
    Sotrudnik,
    PodrazdelenieSotrudnika,
    PodrazdelenieSotrudnikaRoditel,
    DataUvolneniya,
    Kontragent,
    KodGolovnogoKontragenta,
    GolovnojKontragent),
  VT_4 AS(
  SELECT
    DataInteresa,
    NomerInteresa,
    DataOsnovaniyaInteresa,
    NomerOsnovaniyaInteresa,
    StatusInteresa,
    PervichnoeNapravlenie,
    RoditelNapravleniya,
    Departament,
    InteresPometkaUdaleniya,
    SutObrashcheniya,
    SposobPostupleniyaInformacii,
    IstochnikInformacii,
    IstochnikInformaciiIzmenenVRuchnuyu,
    GruppaIstochnikaInformacii,
    NeVpervye,
    DataPervichnogoInteresa,
    NomerPervichnogoInteresa,
    PrichinaNepodgotovkiPredlozheniya,
    TipSobytiya,
    VidSobytiya,
    RegionCRM,
    KodKontragenta,
    OcenkaKachestvaInteresa,
    DataPervogoPredlozheniyaSOtkazom,
    NomerPervogoPredlozheniyaSOtkazom,
    DataPoslednegoPredlozheniyaSOtkazom,
    NomerPoslednegoPredlozheniyaSOtkazom,
    PoslednyayaStranica,
    NapravlenieDlyaKollTrekingaPoslednyayaStranica,
    StranicaVhoda,
    NapravlenieDlyaKollTrekingaStranicaVhoda,
    DataZvonka,
    Avtozvonok,
    EstDannyeKollTrekinga,
    UtmSource,
    UtmMedium,
    CRM_UTMSource,
    CRM_UTMMedium,
    UtmContent,
    UtmCampaign,
    UtmTerm,
    Referrer,
    Callback,
    CallId,
    Keyword,
    ClientId,
    Ip,
    FormId,
    SrednespisochnayaCHislennost,
    Napravlenie,
    NapravlenieRoditel,
    NapravlenieVerhnijUroven,
    Sotrudnik,
    PodrazdelenieSotrudnika,
    PodrazdelenieSotrudnikaRoditel,
    DataUvolneniya,
    Kontragent,
    t1.KodGolovnogoKontragenta,
    GolovnojKontragent,
     KvalificirovannyeInteresy,
    OplachennyeInteresy,
   SummaOplaty,
    VseInteresy,
   DataPredlozheniya,
    NomerPredlozheniya,
   SummaVsekhPredlozheniya,
    MinSummaPredlozheniya,
    SrednayRaschetnayaSummaPredlozheniya,
    SumVsePredlozheniya,
   KvalificirovannyeInteresySrednyayaOcenkaKachestva,
    OplachennyeInteresyPoStatusu,
    OplachennyeInteresySrednyayaOcenkaKachestva,
    OplachennyeInteresyPoStatusuSrednyayaOcenkaKachestva,
    DnejOtPostupleniyaDoOplaty,
    UchityvatPriRascheteDnejOtPostupleniyaDoOplaty,
    VseInteresySrednyayaOcenkaKachestva,
    KolichestvoPredlozhenijSOtkazom,
    PrichinaOtkaza,
   TipUstrojstva,
    MaxSummaPredlozheniya,
    SrednyayaSummaPredlozheniya,
     SummaVyruchkaKontragenta,
    SummaOplatyBezTranzita,
    SummaVozvrataBezTranzita,
    CASE WHEN t2.VyruchkaGolovnogoKontragenta IS NULL THEN 0 ELSE t2.VyruchkaGolovnogoKontragenta END AS VyruchkaGolovnogoKontragenta,
    CASE WHEN (CASE WHEN t2.VyruchkaGolovnogoKontragenta IS NULL THEN 0 ELSE t2.VyruchkaGolovnogoKontragenta END) = 0 THEN 'Нет данных' 
    WHEN (CASE WHEN t2.VyruchkaGolovnogoKontragenta IS NULL THEN 0 ELSE t2.VyruchkaGolovnogoKontragenta END) < 400000000 THEN 'До 400 млн.'
    WHEN (CASE WHEN t2.VyruchkaGolovnogoKontragenta IS NULL THEN 0 ELSE t2.VyruchkaGolovnogoKontragenta END) < 1000000000 THEN 'От 400 млн. до 1 млрд.'
    ELSE 'От 1 млрд' END AS Corp
  FROM
    VT_3 AS t1
  LEFT JOIN
    VT_2 AS t2
  ON
    t1.KodGolovnogoKontragenta = t2.KodGolovnogoKontragenta 
    AND t1.GodInteresa = t2.GodInteresa )
SELECT
  *
FROM
  VT_4